<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MCP Chat Interface</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    #chat-container {
      width: 90%;
      max-width: 700px;
      background: white;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      border-radius: 12px;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      height: 80vh;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .message {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .user { background: #dcf8c6; align-self: flex-end; }
    .bot { background: #f1f0f0; align-self: flex-start; }
    #input-container {
      display: flex;
      padding: 12px;
      border-top: 1px solid #ddd;
    }
    #user-input {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      margin-left: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    button:disabled { background: #999; }
    #debug-log {
      width: 90%;
      max-width: 700px;
      background: #111;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 8px;
      margin-top: 10px;
      border-radius: 8px;
      height: 150px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <button id="connect-btn">Connect MCP Server</button>

  <div id="chat-container">
    <div id="messages"></div>
    <div id="input-container">
      <input id="user-input" placeholder="Type a message..." />
      <button id="send-btn">Send</button>
    </div>
  </div>

  <div id="debug-log"></div>

  <script>
    const BE_URL = "https://f05d2d98b621.ngrok-free.app"; // ‚úÖ your backend
    let sessionEndpoint = null;
    let connected = false;

    const messagesDiv = document.getElementById('messages');
    const logDiv = document.getElementById('debug-log');
    const connectBtn = document.getElementById('connect-btn');
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');

    function addMessage(sender, text) {
      const div = document.createElement('div');
      div.classList.add('message', sender);
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addDebug(level, msg, obj = null) {
      const time = new Date().toLocaleTimeString();
      logDiv.textContent += `[${time}] [${level}] ${msg}\n`;
      if (obj) logDiv.textContent += JSON.stringify(obj, null, 2) + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // üîπ Step 1: Connect MCP Server via SSE
    connectBtn.onclick = () => {
      connectBtn.disabled = true;
      addDebug("INFO", "Connecting to MCP SSE...");
      const eventSource = new EventSource(`${BE_URL}/sse`);

      eventSource.onopen = () => addDebug("SUCCESS", "SSE connection established");

      eventSource.onerror = (err) => {
        addDebug("ERROR", "SSE error", err);
        connectBtn.disabled = false;
        eventSource.close();
      };

      // Handle incoming SSE messages from backend
      eventSource.onmessage = async (event) => {
        addDebug("INFO", "SSE message received", { data: event.data });

        // Expecting something like: event: endpoint\ndata: /messages/?session_id=xxxx
        if (event.data.includes("session_id")) {
          sessionEndpoint = event.data.trim();
          connected = true;
          addDebug("SUCCESS", `Session ID received: ${sessionEndpoint}`);
          addMessage("bot", "‚úÖ Connected to MCP Server.\nYou can now chat.");
        } else if (event.data.startsWith(": ping")) {
          // keep connection alive
          addDebug("DEBUG", "Ping received");
        } else {
          addMessage("bot", event.data);
        }
      };
    };

    // üîπ Step 2: Handle User Message
    sendBtn.onclick = async () => {
      const text = userInput.value.trim();
      if (!text) return;
      addMessage("user", text);
      userInput.value = "";

      if (!connected) {
        addMessage("bot", "‚ö†Ô∏è Not connected yet. Click 'Connect MCP Server' first.");
        return;
      }

      // üîπ Step 3: Decide backend route based on user intent
      let endpoint = "/anthropic";
      if (text.toLowerCase().includes("initiate payment")) endpoint = "/initiate-payment";
      else if (text.toLowerCase().includes("verify payment")) endpoint = "/verify-payment";

      addDebug("INFO", `Calling backend: ${endpoint}`);

      try {
        const res = await fetch(`${BE_URL}${endpoint}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: text, session: sessionEndpoint })
        });

        // Support SSE-style streaming replies
        if (res.headers.get("content-type")?.includes("text/event-stream")) {
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let partial = "";
          addMessage("bot", "ü§ñ ");
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            partial += chunk;
            messagesDiv.lastChild.textContent = "ü§ñ " + partial;
          }
        } else {
          const data = await res.json();
          addMessage("bot", data.reply || JSON.stringify(data, null, 2));
        }
      } catch (err) {
        addDebug("ERROR", "Backend call failed", { message: err.message });
        addMessage("bot", "‚ùå Error contacting backend.");
      }
    };
  </script>
</body>
</html>

